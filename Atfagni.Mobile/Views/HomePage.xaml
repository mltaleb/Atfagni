<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Atfagni.Mobile.ViewModels"
             xmlns:dto="clr-namespace:Atfagni.Shared.DTOs;assembly=Atfagni.Shared"
             x:DataType="vm:HomeViewModel"
             x:Class="Atfagni.Mobile.Views.HomePage"
             Title="Atfagni"
             BackgroundColor="#F8F9FA">
    <!-- Fond gris trÃ¨s lÃ©ger Pro -->

    <ContentPage.Resources>
        <!-- Un petit convertisseur pour inverser les boolÃ©ens si besoin -->
        <Style TargetType="Border">
            <Setter Property="StrokeShape" Value="RoundRectangle 15"/>
            <Setter Property="StrokeThickness" Value="0"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="BackgroundColor" Value="White"/>
            <Setter Property="Shadow">
                <Shadow Brush="Black" Opacity="0.05" Radius="10" Offset="0,5"/>
            </Setter>
        </Style>
    </ContentPage.Resources>
    <Grid>
        <!-- ============================================= -->
        <!-- VUE CHAUFFEUR (Dashboard) -->
        <!-- ============================================= -->
        <RefreshView IsVisible="{Binding IsDriver}" 
                     Command="{Binding LoadDashboardCommand}" 
                     IsRefreshing="{Binding IsBusy}">

            <ScrollView>
                <VerticalStackLayout Padding="20" Spacing="20">

                    <!-- 1. EN-TÃŠTE -->
                    <Grid ColumnDefinitions="*, Auto" VerticalOptions="Center">
                        <VerticalStackLayout Spacing="2">
                            <Label Text="Salam Alaykoum," TextColor="Gray" FontSize="14"/>
                            <Label Text="{Binding DriverName}" TextColor="#111" FontSize="26" FontAttributes="Bold"/>
                        </VerticalStackLayout>

                        <Border Grid.Column="1" HeightRequest="50" WidthRequest="50" Padding="0" StrokeShape="RoundRectangle 25">
                            <Image Source="user_circle.png" Aspect="AspectFill"/>
                        </Border>
                    </Grid>

                    <!-- 2. STATS (Cartes colorÃ©es) -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <!-- Solde -->
                        <Border Grid.Column="0" BackgroundColor="#2196F3">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Mon Solde" TextColor="White" Opacity="0.9" FontSize="12"/>
                                <Label Text="{Binding DashboardData.WalletBalance, StringFormat='{0} DA'}" 
                                       TextColor="White" FontSize="22" FontAttributes="Bold"/>
                            </VerticalStackLayout>
                        </Border>

                        <!-- Voyages -->
                        <Border Grid.Column="1">
                            <VerticalStackLayout Spacing="5">
                                <Label Text="Total Voyages" TextColor="Gray" FontSize="12"/>
                                <Label Text="{Binding DashboardData.CompletedRidesCount}" 
                                       TextColor="#333" FontSize="22" FontAttributes="Bold"/>
                            </VerticalStackLayout>
                        </Border>
                    </Grid>

                    <!-- 3. ACTIONS RAPIDES -->
                    <Label Text="Actions" FontAttributes="Bold" TextColor="Gray" Margin="0,5,0,0"/>
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                        <Button Text="+ PUBLIER" Command="{Binding GoToPublishCommand}"
                                BackgroundColor="#4CAF50" TextColor="White" FontAttributes="Bold" CornerRadius="12" HeightRequest="50"/>

                        <Button Grid.Column="1" Text="DEMANDES" Command="{Binding GoToRequestsCommand}"
                                BackgroundColor="White" TextColor="#2196F3" BorderColor="#2196F3" BorderWidth="1" 
                                FontAttributes="Bold" CornerRadius="12" HeightRequest="50"/>

                        <!-- Badge notification (rouge) -->
                        <Border Grid.Column="1" BackgroundColor="Red" Padding="0" HeightRequest="22" WidthRequest="22" 
                                HorizontalOptions="End" VerticalOptions="Start" Margin="0,-8,-8,0" StrokeShape="RoundRectangle 11"
                                IsVisible="{Binding DashboardData.PendingRequestsCount}">
                            <!-- Si > 0, c'est visible (trick implicite) -->
                            <Label Text="{Binding DashboardData.PendingRequestsCount}" TextColor="White" 
                                   FontSize="11" FontAttributes="Bold" HorizontalOptions="Center" VerticalOptions="Center"/>
                        </Border>
                    </Grid>

                    <!-- 4. PROCHAIN DÃ‰PART -->
                    <Label Text="Prochain DÃ©part" FontAttributes="Bold" TextColor="Gray" Margin="0,5,0,0" IsVisible="{Binding HasNextRide}"/>

                    <!-- Carte du trajet -->
                    <Border IsVisible="{Binding HasNextRide}">
                        <Grid RowDefinitions="Auto, Auto" RowSpacing="10">
                            <Label Text="{Binding DashboardData.NextRide.DepartureTime, StringFormat='{0:dddd d MMMM Ã  HH:mm}'}" 
                                   TextColor="#2196F3" FontAttributes="Bold" FontSize="14"/>

                            <Grid Grid.Row="1" ColumnDefinitions="Auto, *, Auto" VerticalOptions="Center">
                                <Label Grid.Column="0" Text="{Binding DashboardData.NextRide.StartLocation}" FontSize="18" FontAttributes="Bold" TextColor="#333"/>
                                <Label Grid.Column="1" Text="âž" HorizontalOptions="Center" TextColor="#CCC" FontSize="20"/>
                                <Label Grid.Column="2" Text="{Binding DashboardData.NextRide.EndLocation}" FontSize="18" FontAttributes="Bold" TextColor="#333"/>
                            </Grid>
                        </Grid>
                    </Border>

                    <!-- Message vide -->
                    <VerticalStackLayout IsVisible="{Binding HasNextRide, Converter={StaticResource InvertedBoolConverter}}" 
                                         Spacing="10" Padding="20">
                        <Label Text="ðŸ’¤" FontSize="40" HorizontalOptions="Center"/>
                        <Label Text="Aucun trajet prÃ©vu." HorizontalOptions="Center" TextColor="Gray"/>
                        <Label Text="Publiez votre prochain voyage !" HorizontalOptions="Center" TextColor="#2196F3" FontAttributes="Bold"/>
                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>


        <!-- ============================================= -->
        <!-- VUE PASSAGER (Recherche) -->
        <!-- ============================================= -->
        <Grid RowDefinitions="Auto, *" IsVisible="{Binding IsPassenger}" Padding="20" RowSpacing="20">

            <!-- 1. En-tÃªte Passager -->
            <VerticalStackLayout Grid.Row="0" Spacing="15">
                <Label Text="{Binding UserName, StringFormat='Bonjour {0},'}" FontSize="18" TextColor="Gray"/>
                <Label Text="OÃ¹ voulez-vous aller ?" FontSize="28" FontAttributes="Bold" TextColor="Black"/>

                <!-- BoÃ®te de Recherche (Style Carte) -->
                <Border  Stroke="Transparent" StrokeThickness="0" Padding="15" BackgroundColor="White" HorizontalOptions="Fill" VerticalOptions="Fill">
                    <VerticalStackLayout Spacing="10">
                        <!-- DÃ©part -->
                        <Grid ColumnDefinitions="30, *">
                            <Label Text="ðŸ“" VerticalOptions="Center"/>
                            <Entry Grid.Column="1" Placeholder="DÃ©part (ex: Tindouf)" Text="{Binding SearchFrom}" />
                        </Grid>
                        <BoxView HeightRequest="1" Color="#EEEEEE"/>

                        <!-- ArrivÃ©e -->
                        <Grid ColumnDefinitions="30, *">
                            <Label Text="ðŸ" VerticalOptions="Center"/>
                            <Entry Grid.Column="1" Placeholder="ArrivÃ©e (ex: Zouerate)" Text="{Binding SearchTo}" />
                        </Grid>
                        <BoxView HeightRequest="1" Color="#EEEEEE"/>

                        <!-- Date -->
                        <Grid ColumnDefinitions="30, *">
                            <Label Text="ðŸ“…" VerticalOptions="Center"/>
                            <DatePicker Grid.Column="1" Date="{Binding SearchDate}" Format="dddd d MMMM" />
                        </Grid>

                        <!-- Bouton Rechercher -->
                        <Button Text="RECHERCHER" Command="{Binding SearchRidesCommand}" 
                                BackgroundColor="#2196F3" CornerRadius="10" Margin="0,10,0,0"/>
                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>

            <!-- 2. RÃ©sultats de recherche -->
            <CollectionView Grid.Row="1" ItemsSource="{Binding SearchResults}" SelectionMode="None">
                <CollectionView.Header>
                    <Label Text="Trajets disponibles" FontAttributes="Bold" Margin="0,0,0,10"/>
                </CollectionView.Header>

                <CollectionView.EmptyView>
                    <Label Text="Lancez une recherche pour voir les trajets." 
                           HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dto:RideDto">
                        <!-- CARTE TRAJET (Style Blablacar) -->
                        <Border Margin="0,5" Padding="15"  Stroke="Transparent" StrokeThickness="0" BackgroundColor="White" HorizontalOptions="Fill" VerticalOptions="Fill">
                            <Border.GestureRecognizers>
                                <!-- Clic sur la carte -> DÃ©tails -->
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HomeViewModel}}, Path=GoToRideDetailCommand}"
                                                      CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>

                            <Grid RowDefinitions="Auto, Auto, Auto" ColumnDefinitions="*, Auto">
                                <!-- Heure et Trajet -->
                                <VerticalStackLayout Grid.Row="0">
                                    <Label Text="{Binding DepartureTime, StringFormat='{0:HH:mm}'}" FontAttributes="Bold" FontSize="18"/>
                                    <Label Text="{Binding StartLocation, StringFormat='{0} âž {1}'}" TextColor="Gray"/>
                                </VerticalStackLayout>

                                <!-- Prix -->
                                <Label Grid.Column="1" Text="{Binding Price, StringFormat='{0} DA'}" 
                                       FontAttributes="Bold" FontSize="18" TextColor="#2196F3"/>

                                <!-- Chauffeur -->
                                <HorizontalStackLayout Grid.Row="2" Grid.ColumnSpan="2" Margin="0,10,0,0" Spacing="10">
                                    <Image Source="user_circle.png" HeightRequest="20"/>
                                    <Label Text="{Binding DriverName}" VerticalOptions="Center"/>

                                    <!-- IcÃ´ne Colis si acceptÃ© -->
                                    <Border IsVisible="{Binding AcceptsPackages}" Padding="5,2" BackgroundColor="#E3F2FD"  Stroke="Transparent" StrokeThickness="0" HorizontalOptions="Start" VerticalOptions="Center">
                                        <Label Text="ðŸ“¦ Colis OK" FontSize="10" TextColor="#1976D2"/>
                                    </Border>
                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Grid>
</ContentPage>