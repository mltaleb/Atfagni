<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:vm="clr-namespace:Atfagni.Mobile.ViewModels"
             xmlns:dto="clr-namespace:Atfagni.Shared.DTOs;assembly=Atfagni.Shared"
             x:DataType="vm:HomeViewModel"
             xmlns:controls="clr-namespace:Atfagni.Mobile.Controls"
             x:Class="Atfagni.Mobile.Views.HomePage"
             xmlns:converters="clr-namespace:Atfagni.Mobile.Converters"
             Title="Atfagni"
             BackgroundColor="#F8F9FA">
    <!-- Fond gris trÃ¨s lÃ©ger Pro -->
   
    <ContentPage.Resources>
        <converters:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <!-- Un petit convertisseur pour inverser les boolÃ©ens si besoin -->
        <Style TargetType="Border">
            <Setter Property="StrokeShape" Value="RoundRectangle 15"/>
            <Setter Property="StrokeThickness" Value="0"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="BackgroundColor" Value="White"/>
            <Setter Property="Shadow">
                <Shadow Brush="Black" Opacity="0.05" Radius="10" Offset="0,5"/>
            </Setter>
        </Style>
    </ContentPage.Resources>
    <Grid>
        <!-- ============================================= -->
        <!-- VUE CHAUFFEUR (Dashboard) -->
        <!-- ============================================= -->
        <!-- DANS LA VUE CHAUFFEUR -->
        <ScrollView IsVisible="{Binding IsDriver}">
            <VerticalStackLayout Padding="20" Spacing="20">

                <!-- 1. HEADER MODERNE -->
                <Grid ColumnDefinitions="*, Auto">
                    <VerticalStackLayout Spacing="2">
                        <Label Text="Portefeuille" TextColor="Gray" FontSize="12"/>
                        <Label Text="{Binding DashboardData.WalletBalance, StringFormat='{0} DA'}" 
                       TextColor="#2196F3" FontSize="28" FontAttributes="Bold"/>
                    </VerticalStackLayout>
                    <Border StrokeShape="RoundRectangle 25" HeightRequest="50" WidthRequest="50" Padding="0">
                        <Image Source="user_circle.jpg" 
           Aspect="AspectFill"
           HeightRequest="50" 
           WidthRequest="50"/>
                        <!-- AJOUTEZ Ã‡A -->
                    </Border>
                </Grid>

                <!-- 2. SECTION URGENTE (Demandes en attente) -->
                <!-- Visible seulement s'il y a des demandes (Count > 0) -->
                <Border BackgroundColor="#FFF3E0" StrokeThickness="0" StrokeShape="RoundRectangle 15" Padding="15"
                IsVisible="{Binding DashboardData.PendingRequestsCount, Converter={StaticResource IntToBoolConverter}}">
                    <Grid ColumnDefinitions="Auto, *, Auto">
                        <Label Text="âš ï¸" VerticalOptions="Center" FontSize="20"/>

                        <VerticalStackLayout Grid.Column="1" Margin="10,0">
                            <Label Text="Action Requise" TextColor="#E65100" FontAttributes="Bold" FontSize="12"/>
                            <Label Text="{Binding DashboardData.PendingRequestsCount, StringFormat='{0} demandes en attente'}" 
                           TextColor="#EF6C00" FontAttributes="Bold"/>
                        </VerticalStackLayout>

                        <Button Grid.Column="2" Text="VOIR" Command="{Binding GoToRequestsCommand}"
                        BackgroundColor="#EF6C00" TextColor="White" HeightRequest="35" FontSize="12" CornerRadius="18"/>
                    </Grid>
                </Border>

                <!-- 3. PROCHAIN DÃ‰PART (Design Billet) -->
                <Label Text="Prochain DÃ©part" FontAttributes="Bold" TextColor="Gray" Margin="0,5,0,0"/>

                <Border BackgroundColor="White" StrokeThickness="0" StrokeShape="RoundRectangle 15" Padding="0">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.05" Radius="10" Offset="0,5"/>
                    </Border.Shadow>

                    <Grid RowDefinitions="40, Auto, 40">
                        <!-- Haut du billet (Date) -->
                        <Border Grid.Row="0" BackgroundColor="#2196F3" StrokeThickness="0" 
                        StrokeShape="RoundRectangle 15,15,0,0" Padding="15,0">
                            <Label Text="{Binding DashboardData.NextRide.DepartureTime, StringFormat='{0:dddd d MMMM Ã  HH:mm}'}" 
                           TextColor="White" FontAttributes="Bold" VerticalOptions="Center"/>
                        </Border>

                        <!-- Milieu (Trajet) -->
                        <Grid Grid.Row="1" ColumnDefinitions="Auto, *, Auto" Padding="20">
                            <VerticalStackLayout HorizontalOptions="Start">
                                <Label Text="DÃ‰PART" FontSize="10" TextColor="Gray"/>
                                <Label Text="{Binding DashboardData.NextRide.StartLocation}" FontSize="18" FontAttributes="Bold" TextColor="#333"/>
                            </VerticalStackLayout>

                            <Label Grid.Column="1" Text="âž" FontSize="20" HorizontalOptions="Center" VerticalOptions="Center" TextColor="#CCC"/>

                            <VerticalStackLayout Grid.Column="2" HorizontalOptions="End">
                                <Label Text="ARRIVÃ‰E" FontSize="10" TextColor="Gray" HorizontalOptions="End"/>
                                <Label Text="{Binding DashboardData.NextRide.EndLocation}" FontSize="18" FontAttributes="Bold" TextColor="#333"/>
                            </VerticalStackLayout>
                        </Grid>

                        <!-- Bas (Passagers validÃ©s / Total) -->
                        <Border Grid.Row="2" BackgroundColor="#F5F5F5" StrokeThickness="0" 
                        StrokeShape="RoundRectangle 0,0,15,15" Padding="15,0">
                            <HorizontalStackLayout VerticalOptions="Center" Spacing="5">
                                <Label Text="ðŸ‘¥" FontSize="12"/>
                                <Label Text="{Binding DashboardData.NextRide.AvailableSeats, StringFormat='{0} places libres'}" 
                               FontSize="12" TextColor="Gray"/>
                            </HorizontalStackLayout>
                        </Border>
                    </Grid>
                </Border>

                <!-- 4. MENUS RAPIDES (Grille de boutons) -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="15" RowDefinitions="80">

                    <!-- Historique -->
                    <Border Grid.Column="0" BackgroundColor="White" StrokeShape="RoundRectangle 15" StrokeThickness="0" Padding="15">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToHistoryCommand}"/>
                        </Border.GestureRecognizers>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="5">
                            <Image Source="history.png" HeightRequest="24" WidthRequest="24"/>
                            <!-- Mets une icone -->
                            <Label Text="Historique" FontAttributes="Bold" TextColor="#333"/>
                        </VerticalStackLayout>
                    </Border>

                    <!-- Nouveau Trajet -->
                    <Border Grid.Column="1" BackgroundColor="#E3F2FD" StrokeShape="RoundRectangle 15" StrokeThickness="0" Padding="15">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding GoToPublishCommand}"/>
                        </Border.GestureRecognizers>
                        <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="5">
                            <Label Text="+" FontSize="24" TextColor="#2196F3" FontAttributes="Bold"/>
                            <Label Text="Publier" FontAttributes="Bold" TextColor="#2196F3"/>
                        </VerticalStackLayout>
                    </Border>
                </Grid>
            </VerticalStackLayout>
        </ScrollView>

        <!-- ============================================= -->
        <!-- VUE PASSAGER (Recherche) -->
        <!-- ============================================= -->
        <Grid RowDefinitions="Auto, *" IsVisible="{Binding IsPassenger}" Padding="20" RowSpacing="20">

            <!-- DANS LA VUE PASSAGER -->
            <VerticalStackLayout Spacing="15">

                <Label Text="OÃ¹ voulez-vous aller ?" FontSize="28" FontAttributes="Bold" TextColor="Black"/>

                <Border StrokeShape="RoundRectangle 15" BackgroundColor="White" Padding="15" StrokeThickness="0">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.1" Radius="10" Offset="0,5"/>
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="15">

                        <!-- ZONE DÃ‰PART -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="DÃ‰PART" FontSize="10" FontAttributes="Bold" TextColor="Gray" Margin="5,0"/>

                            <Border Stroke="#F0F0F0" StrokeThickness="1" StrokeShape="RoundRectangle 10" BackgroundColor="#FAFAFA" Padding="15">
                                <!-- C'EST ICI QU'ON APPELLE LA COMMANDE -->
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenCityPickerCommand}" CommandParameter="Departure" />
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="30, *">
                                    <Label Text="ðŸ“" VerticalOptions="Center" />
                                    <!-- On affiche la ville sÃ©lectionnÃ©e ou un texte par dÃ©faut -->
                                    <Label Grid.Column="1" 
                   Text="{Binding SelectedDeparture, TargetNullValue='partez-vous ?'}" 
                   TextColor="{Binding SelectedDeparture, Converter={StaticResource StringToColorConverter}}"
                   FontSize="16" VerticalOptions="Center" />
                                </Grid>
                            </Border>
                        </VerticalStackLayout>

                        <!-- ZONE ARRIVÃ‰E -->
                        <VerticalStackLayout Spacing="5" Margin="0,10,0,0">
                            <Label Text="ARRIVÃ‰E" FontSize="10" FontAttributes="Bold" TextColor="Gray" Margin="5,0"/>

                            <Border Stroke="#F0F0F0" StrokeThickness="1" StrokeShape="RoundRectangle 10" BackgroundColor="#FAFAFA" Padding="15">
                                <!-- APPEL DE LA COMMANDE POUR L'ARRIVÃ‰E -->
                                <Border.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding OpenCityPickerCommand}" CommandParameter="Arrival" />
                                </Border.GestureRecognizers>

                                <Grid ColumnDefinitions="30, *">
                                    <Label Text="ðŸ" VerticalOptions="Center" />
                                    <Label Grid.Column="1" 
                   Text="{Binding SelectedArrival, TargetNullValue='OÃ¹ allez-vous ?'}" 
                   TextColor="{Binding SelectedArrival, Converter={StaticResource StringToColorConverter}}"
                   FontSize="16" VerticalOptions="Center" />
                                </Grid>
                            </Border>
                        </VerticalStackLayout>
                        <!-- DATE -->
                        <VerticalStackLayout Spacing="5">
                            <Label Text="DATE" FontSize="10" FontAttributes="Bold" TextColor="Gray" Margin="5,0"/>
                            <DatePicker Date="{Binding SearchDate}" Format="D" TextColor="Black"/>
                        </VerticalStackLayout>

                        <Button Text="TROUVER UN TRAJET" 
                    Command="{Binding SearchRidesCommand}"
                    BackgroundColor="#2196F3" 
                    CornerRadius="12" 
                    HeightRequest="55" 
                    FontAttributes="Bold" />

                    </VerticalStackLayout>
                </Border>
            </VerticalStackLayout>


            <!-- 2. RÃ©sultats de recherche -->
            <CollectionView Grid.Row="1" ItemsSource="{Binding SearchResults}" SelectionMode="None">
                <CollectionView.Header>
                    <Label Text="Trajets disponibles" FontAttributes="Bold" Margin="0,0,0,10"/>
                </CollectionView.Header>

                <CollectionView.EmptyView>
                    <Label Text="Lancez une recherche pour voir les trajets." 
                           HorizontalOptions="Center" VerticalOptions="Center" TextColor="Gray"/>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dto:RideDto">
                        <!-- CARTE TRAJET (Style Blablacar) -->
                        <Border Margin="0,5" Padding="15"  Stroke="Transparent" StrokeThickness="0" BackgroundColor="White" HorizontalOptions="Fill" VerticalOptions="Fill">
                            <Border.GestureRecognizers>
                                <!-- Clic sur la carte -> DÃ©tails -->
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:HomeViewModel}}, Path=GoToRideDetailCommand}"
                                                      CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>

                            <Grid RowDefinitions="Auto, Auto, Auto" ColumnDefinitions="*, Auto">
                                <!-- Heure et Trajet -->
                                <VerticalStackLayout Grid.Row="0">
                                    <Label Text="{Binding DepartureTime, StringFormat='{0:HH:mm}'}" FontAttributes="Bold" FontSize="18"/>
                                    <Label Text="{Binding StartLocation, StringFormat='{0} âž {1}'}" TextColor="Gray"/>
                                </VerticalStackLayout>

                                <!-- Prix -->
                                <Label Grid.Column="1" Text="{Binding Price, StringFormat='{0} DA'}" 
                                       FontAttributes="Bold" FontSize="18" TextColor="#2196F3"/>

                                <!-- Chauffeur -->
                                <HorizontalStackLayout Grid.Row="2" Grid.ColumnSpan="2" Margin="0,10,0,0" Spacing="10">
                                    <Image Source="user_circle.png" HeightRequest="20"/>
                                    <Label Text="{Binding DriverName}" VerticalOptions="Center"/>

                                    <!-- IcÃ´ne Colis si acceptÃ© -->
                                    <Border IsVisible="{Binding AcceptsPackages}" Padding="5,2" BackgroundColor="#E3F2FD"  Stroke="Transparent" StrokeThickness="0" HorizontalOptions="Start" VerticalOptions="Center">
                                        <Label Text="ðŸ“¦ Colis OK" FontSize="10" TextColor="#1976D2"/>
                                    </Border>
                                </HorizontalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
        <controls:LoadingOverlay IsBusy="{Binding IsBusy}" 
                         LoadingMessage="chercher des trajets..." />
    </Grid>
</ContentPage>